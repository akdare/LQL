/**
 * 2007-2020 PrestaShop
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@prestashop.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade PrestaShop to newer
 * versions in the future. If you wish to customize PrestaShop for your
 * needs please refer to http://www.prestashop.com for more information.
 *
 * @author    Boxtal <api@boxtal.com>
 *
 * @copyright 2007-2020 PrestaShop SA / 2018-2020 Boxtal
 *
 * @license   http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 * International Registered Trademark & Property of PrestaShop SA
 */
var bxParcelPoint={trigger:".bx-select-parcel",initialized:!1,mapContainer:null,map:null,markers:[],carrierTextCache:{},init:function(){const e=this;e.initialized||(e.initialized=!0,e.mapContainer=document.querySelector("#bx-map"),e.mapContainer||e.initMap(),e.initCarriers(),e.on("body","click",e.trigger,(function(){e.openMap(),e.getPoints()})),window.MutationObserver?(e.observeDomMutations(e.getAllCarrierInputsSelector(),(function(){e.initCarriers()})),e.on("body","click",e.getAllCarrierInputsSelector(),(function(){e.initCarriers()}))):e.on("body","change",e.getAllCarrierInputsSelector(),(function(){e.initCarriers()})),e.on("body","click",".bx-parcel-point-button",(function(t){e.selectPoint(this.getAttribute("data-code"),unescape(this.getAttribute("data-name")),this.getAttribute("data-network"),unescape(this.getAttribute("data-street")),unescape(this.getAttribute("data-zipcode")),unescape(this.getAttribute("data-city")),unescape(this.getAttribute("data-country")),unescape(this.getAttribute("data-openinghours")),unescape(this.getAttribute("data-distance"))).then((function(){e.initCarriers(),e.closeMap()}))["catch"]((function(t){e.showError(t)}))})))},initMap:function(){const e=this,t=document.createElement("div");t.setAttribute("class","bx-close"),t.setAttribute("title",bxTranslation.text.closeMap),t.addEventListener("click",(function(){e.closeMap()}));const n=document.createElement("div");n.setAttribute("id","bx-map-canvas");const o=document.createElement("div");o.setAttribute("id","bx-map-container"),o.appendChild(n);const r=document.createElement("div");r.setAttribute("id","bx-pp-container");const i=document.createElement("div");i.setAttribute("id","bx-map-inner"),i.appendChild(t),i.appendChild(o),i.appendChild(r),e.mapContainer=document.createElement("div"),e.mapContainer.setAttribute("id","bx-map"),e.mapContainer.appendChild(i),document.body.appendChild(e.mapContainer),mapboxgl.accessToken="whatever",e.map=new mapboxgl.Map({container:"bx-map-canvas",style:bxMapUrl,zoom:14}),e.map.addControl(new mapboxgl.NavigationControl);const a=document.createElement("img");a.setAttribute("src",bxMapLogoImageUrl);const c=document.createElement("a");c.setAttribute("href",bxMapLogoHrefUrl),c.setAttribute("target","_blank"),c.appendChild(a);const s=document.createElement("div");s.setAttribute("id","bx-boxtal-logo"),s.appendChild(c);const l=document.querySelector(".mapboxgl-ctrl-top-left");l&&l.appendChild(s)},initCarriers:function(){const e=this,t=e.getCarriers(),n=e.getSelectedCarrier();for(let o=0;o<t.length;o++){const r=t[o];if(null===r.querySelector(".bx-extra-content")){const e=document.createElement("div");e.setAttribute("class","col-sm-12 bx-extra-content"),r.appendChild(e)}const i=r.querySelector(".bx-extra-content");n===e.getCarrierId(r)?e.getSelectedCarrierText(n,i):i.innerHTML=""}},getCarriers:function(){let e=document.querySelectorAll(".delivery-option");return 0===e.length&&(e=document.querySelectorAll("td.delivery_option_radio")),0===e.length&&(e=document.querySelectorAll(".delivery_option")),e},openMap:function(){this.mapContainer.classList.add("bx-modal-show");let e=window.pageYOffset+(window.innerHeight-this.mapContainer.offsetHeight)/2;e<window.pageYOffset&&(e=window.pageYOffset),this.mapContainer.style.top=e+"px",this.map.resize()},closeMap:function(){this.mapContainer.classList.remove("bx-modal-show"),this.clearMarkers()},getPoints:function(){const e=this;e.getParcelPoints().then((function(t){e.addParcelPointMarkers(t.nearbyParcelPoints),e.fillParcelPointPanel(t.nearbyParcelPoints),e.addRecipientMarker(t.searchLocation),e.setMapBounds()}))["catch"]((function(t){e.showError(t)}))},getParcelPoints:function(){const e=this;return new Promise((function(t,n){const o=e.getSelectedCarrier();o||n(bxTranslation.error.carrierNotFound);const r=new XMLHttpRequest;r.onreadystatechange=function(){if(4===r.readyState)if(200!==r.status)n();else{const e="object"==typeof r.response&&null!==r.response?r.response:JSON.parse(r.response);t(e)}},r.open("POST",bxAjaxUrl),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.responseType="json",r.send("route=getPoints&carrier="+encodeURIComponent(o)+"&cartId="+encodeURIComponent(bxCartId)+"&token="+encodeURIComponent(bxToken))}))},addParcelPointMarkers:function(e){for(let t=0;t<e.length;t++)e[t].index=t,this.addParcelPointMarker(e[t])},generateParcelPointTagData:function(e){return' data-code="'+e.parcelPoint.code+'" data-name="'+escape(e.parcelPoint.name)+'" data-network="'+e.parcelPoint.network+'" data-zipcode="'+escape(e.parcelPoint.location.zipCode)+'" data-country="'+escape(e.parcelPoint.location.country)+'" data-city="'+escape(e.parcelPoint.location.city)+'" data-street="'+escape(e.parcelPoint.location.street)+'" data-openinghours="'+escape(JSON.stringify(e.parcelPoint.openingDays))+'" data-distance="'+escape(JSON.stringify(e.distanceFromSearchLocation))+'" '},formatOpeningDays:function(e){for(var t=[],n=0;n<e.length;n++){var o=e[n];if(o.weekday){for(var r=o.weekday[0]+" ",i=o.openingPeriods,a=[],c=0;c<i.length;c++){var s=i[c],l=s.openingTime===undefined?"":s.openingTime,d=s.closingTime===undefined?"":s.closingTime;""!==l&&""!==d&&a.push(l+"-"+d)}for(;a.length<2;)a.push(bxTranslation.text.closedLabel);r+=a.join(" "),n%2==1&&(r='<span style="background-color: #d8d8d8;">'+r+"</span>"),t.push(r)}}return t.join("\n")},addParcelPointMarker:function(e){let t=null;"number"==typeof e.distanceFromSearchLocation&&(t=Math.round(e.distanceFromSearchLocation/100)/10);let n="<div class='bx-marker-popup'><b>"+e.parcelPoint.name+"</b><br/>"+e.parcelPoint.location.street+"<br/>"+e.parcelPoint.location.zipCode+" "+e.parcelPoint.location.city+(null===t?"":" ("+bxTranslation.distance.replace("%s",t)+")")+'<br/><a href="#" class="bx-parcel-point-button" '+this.generateParcelPointTagData(e)+"><b>"+bxTranslation.text.chooseParcelPoint+'</b></a><pre class="bx-parcel-point-schedule">'+this.formatOpeningDays(e.parcelPoint.openingDays)+"</pre>";const o=this.getMarkerHtmlElement(e.index+1),r=new mapboxgl.Popup({offset:25}).setHTML(n),i=new mapboxgl.Marker({element:o,anchor:"bottom"}).setLngLat(new mapboxgl.LngLat(parseFloat(e.parcelPoint.location.position.longitude),parseFloat(e.parcelPoint.location.position.latitude))).setPopup(r).addTo(this.map);this.markers.push(i),this.addRightColMarkerEvent(i,e.parcelPoint.code)},addRightColMarkerEvent:function(e,t){this.on("body","click",".bx-show-info-"+t,(function(){e.togglePopup()}))},formatHours:function(e){const t=e.split(":");return 3===t.length&&(e=t[0]+":"+t[1]),e},addRecipientMarker:function(e){const t=document.createElement("div");t.className="bx-marker-recipient";const n=new mapboxgl.Marker({element:t,anchor:"bottom"}).setLngLat(new mapboxgl.LngLat(parseFloat(e.position.longitude),parseFloat(e.position.latitude))).addTo(this.map);this.markers.push(n)},setMapBounds:function(){let e=new mapboxgl.LngLatBounds;for(let t=0;t<this.markers.length;t++){const n=this.markers[t];e=e.extend(n.getLngLat())}this.map.fitBounds(e,{padding:30,linear:!0})},fillParcelPointPanel:function(e){let t="";t+="<table><tbody>";for(let n=0;n<e.length;n++){const o=e[n];let r=null;"number"==typeof o.distanceFromSearchLocation&&(r=Math.round(o.distanceFromSearchLocation/100)/10),t+="<tr>",t+="<td>"+this.getMarkerHtmlElement(n+1).outerHTML,t+='<div class="bx-parcel-point-title"><a class="bx-show-info-'+o.parcelPoint.code+'">'+o.parcelPoint.name+"</a></div><br/>",t+=o.parcelPoint.location.street+"<br/>",t+=o.parcelPoint.location.zipCode+" "+o.parcelPoint.location.city+(null===r?"":" ("+bxTranslation.distance.replace("%s",r)+")")+"<br/>",t+='<a class="bx-parcel-point-button" '+this.generateParcelPointTagData(o)+'"><b>'+bxTranslation.text.chooseParcelPoint+"</b></a>",t+="</td>",t+="</tr>"}t+="</tbody></table>",document.querySelector("#bx-pp-container").innerHTML=t},getMarkerHtmlElement:function(e){const t=document.createElement("div");return t.className="bx-marker",t.innerHTML=e,t},selectPoint:function(e,t,n,o,r,i,a,c,s){const l=this;return new Promise((function(d,p){const u=l.getSelectedCarrier();u||p(bxTranslation.error.carrierNotFound);const m=new XMLHttpRequest;m.onreadystatechange=function(){4===m.readyState&&(200!==m.status?p(bxTranslation.error.couldNotSelectPoint):d())},m.open("POST",bxAjaxUrl),m.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),m.responseType="json",m.send("route=setPoint&carrier="+encodeURIComponent(u)+"&code="+encodeURIComponent(e)+"&name="+encodeURIComponent(t)+"&address="+encodeURIComponent(o)+"&zipcode="+encodeURIComponent(r)+"&city="+encodeURIComponent(i)+"&country="+encodeURIComponent(a)+"&openingHours="+encodeURIComponent(c)+"&distance="+encodeURIComponent(s)+"&network="+encodeURIComponent(n)+"&cartId="+encodeURIComponent(bxCartId)+"&token="+encodeURIComponent(bxToken))}))},clearMarkers:function(){for(let e=0;e<this.markers.length;e++)this.markers[e].remove();this.markers=[]},getUniqueCarrier:function(){return document.querySelector('input[type="hidden"].shipping_method')},hasUniqueCarrier:function(){return null!==this.getUniqueCarrier()},getCarrierId:function(e){if(this.hasUniqueCarrier()){return this.getUniqueCarrier().getAttribute("value")}return e.querySelector("input[type=radio]").getAttribute("value")},getSelectedCarrier:function(){let e;if(this.hasUniqueCarrier()){e=this.getUniqueCarrier().getAttribute("value")}else{e=this.getSelectedInput().getAttribute("value")}return e},getSelectedCarrierText:function(e,t){if(null===e)return"";const n=this.carrierTextCache;n[e]!==undefined&&(t.innerHTML=n[e]);const o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===o.readyState){if(200!==o.status)t.innerHTML="";else{const e="object"==typeof o.response&&null!==o.response?o.response:JSON.parse(o.response);t.innerHTML=e.text}n[e]=t.innerHTML}},o.open("POST",bxAjaxUrl),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.responseType="json",o.send("route=getSelectedCarrierText&carrier="+encodeURIComponent(e)+"&cartId="+encodeURIComponent(bxCartId)+"&token="+encodeURIComponent(bxToken))},getSelectedInput:function(){var e=document.querySelector(".delivery-option input[type='radio']:checked");return null===e&&(e=document.querySelector(".delivery_option_radio input[type='radio']:checked")),null===e&&(e=document.querySelector(".delivery_option input[type='radio']:checked")),e},getAllCarrierInputsSelector:function(){let e=".delivery-option input[type='radio']";return e+=", .delivery_option_radio input[type='radio']",e+=", .delivery_option input[type='radio']",".delivery-option input[type='radio'], .delivery_option_radio input[type='radio'], .delivery_option input[type='radio']"},showError:function(e){this.closeMap(),alert(e)},isDescendant:function(e,t){for(var n=t.parentNode;null!=n;){if(n==e)return!0;n=n.parentNode}return!1},on:function(e,t,n,o){const r=document.querySelector(e);r.addEventListener(t,(function(e){const t=r.querySelectorAll(n),i=e.target;for(let n=0,a=t.length;n<a;n++){let a=i;const c=t[n];for(;a&&a!==r;){if(a===c)return o.call(c,e);a=a.parentNode}}}))},observeDomMutations:function(e,t){window.MutationObserver&&new MutationObserver((function(n){const o=[];for(let t of n)if("childList"===t.type){const n=Array.from(document.body.querySelectorAll(e)),r=Array.from(t.addedNodes);-1===n.indexOf(t.target)&&r.find(e=>-1!==n.indexOf(e))===undefined&&r.find(t=>!(t instanceof Text)&&null!==t.querySelector(e))===undefined&&n.find(e=>r.find(t=>bxParcelPoint.isDescendant(e,t))!==undefined)===undefined||o.push(t)}o.length>0&&t(o)})).observe(document.body,{attributes:!0,childList:!0,subtree:!0})}};